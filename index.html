
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命令数据库</title>
    <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
    <link rel="stylesheet" href="styles/bootstrap.min.css">
    <link rel="stylesheet" href="styles/command.css">
    <!--<link rel="stylesheet" href="styles/style.css">-->
</head>
<body>
    <div class="command-container p-4">
        <!-- 标题、搜索、服务端信息布局 -->
        <div class="d-flex align-items-center mb-3 position-relative">
            <!-- 搜索框: 宽度增加 -->
            <div class="flex-shrink-0 me-3" style="width: 20%;">
                <input type="text" id="search-input" class="form-control" placeholder="搜索命令、描述或分类...">
            </div>
            <!-- 标题 绝对居中 -->
            <div class="position-absolute start-50 translate-middle-x">
                <h1 class="mb-0">命令数据库</h1>
            </div>
            <!-- 右侧按钮组 -->
            <div class="ms-auto d-flex">

            </div>
        </div>

        <div id="loading" class="text-center">初始化数据加载...</div>
        
        <div class="table-responsive d-none" id="table-container">
            <table class="command-table table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th class="col-id">ID</th>
                        <th class="col-category">分类</th>
                        <th class="col-description">描述1</th>
                        <th class="col-description">描述2</th>
                        <th class="col-command">命令</th>
                        <th class="col-comments">注释</th>
                        <th class="col-action">操作</th>
                    </tr>
                </thead>
                <tbody id="data-container"></tbody>
            </table>
        </div>

        <!-- 分页容器 -->
        <div id="pagination" class="d-flex justify-content-center mt-4"></div>
    </div>



            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        
        // 分页配置
        let currentPage = 1;
        let itemsPerPage = 10;
        let allData = [];
        let filteredData = [];

        // 调试配置
        const DEBUG_MODE = false;
        let performanceMetrics = { requestStart: 0, domReady: Date.now() };
        logDebugInfo(`DOM加载完成 (耗时: ${Date.now() - performanceMetrics.domReady}ms)`);

        function logDebugInfo(message) {
            if(!DEBUG_MODE) return;
            const timestamp = new Date().toLocaleTimeString();
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML += `<div class="debug-entry"><span class="text-muted">[${timestamp}]</span><span class="ms-2">${message}</span></div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function toggleDebug() {
            const panel = document.querySelector('.debug-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // 获取数据
        performanceMetrics.requestStart = Date.now();
        fetch('commands.json')
            .then(response => {
                logDebugInfo(`HTTP响应状态: ${response.status} ${response.statusText}`);
                if(!response.ok) throw new Error(`HTTP错误: ${response.status}`);
                return response.json();
            })
            .then(data => {
                logDebugInfo(`数据接收完成 (总耗时: ${Date.now() - performanceMetrics.requestStart}ms)`);
                processData(data);
            })
            .catch(error => handleError(error));
            
        // 键盘快捷键：左右箭头切换分页，Home/End跳首尾
        document.addEventListener('keydown', (e) => {
        const tag = document.activeElement.tagName.toLowerCase();
        if (tag === 'input' || tag === 'textarea') return;
        const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
        switch (e.key) {
            case 'ArrowLeft':
                changePage(currentPage - 1);
                break;
            case 'ArrowRight':
                changePage(currentPage + 1);
                break;
            case 'Home':
                changePage(1);
                break;
            case 'End':
                changePage(totalPages);
                break;
        }
    });

        // 数据处理
        function processData(data) {
            allData = data;
            filteredData = allData;

            if(!data || data.length === 0) {
                showMessage('没有找到任何命令记录', 'info');
                return;
            }

            const expectedFields = ['id','category','description1','description2','command','comments'];
            const isValid = data.every(item => expectedFields.every(field => field in item));
            if(!isValid) {
                showMessage('数据字段不匹配，请检查API响应', 'danger');
                logDebugInfo('无效数据结构: ' + JSON.stringify(data[0]));
                return;
            }

            // 初始化渲染
            renderTable();
            renderPagination();
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('table-container').classList.remove('d-none');
            logDebugInfo(`成功渲染 ${data.length} 条记录`);

            // 搜索功能绑定
            document.getElementById('search-input').addEventListener('input', searchTable);
        }

        // 搜索过滤
        function searchTable(e) {
            const query = e.target.value.trim().toLowerCase();
            filteredData = allData.filter(item => {
                return ['id','category','description1','description2','command','comments']
                    .some(key => (item[key] || '').toString().toLowerCase().includes(query));
            });
            currentPage = 1;
            renderTable();
            renderPagination();
        }

        // 渲染表格
        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const slice = filteredData.slice(start, end);
            const container = document.getElementById('data-container');
            container.innerHTML = slice.map(item => `
                <tr valign="middle">
                    <td data-label="ID">${escapeHtml(item.id)}</td>
                    <td data-label="分类">${renderCategory(item.category)}</td>
                    <td data-label="描述1">${escapeHtml(item.description1)}</td>
                    <td data-label="描述2">${escapeHtml(item.description2)}</td>
                    <td data-label="命令"><pre class="command-code">${escapeHtml(item.command)}</pre></td>
                    <td data-label="注释">${renderComments(item.comments)}</td>
                    <td data-label="复制">
                        <button class="btn btn-sm btn-outline-primary copy-btn" title="复制命令" data-command="${escapeHtml(item.command)}" aria-label="复制命令">
                            <span class="copy-icon"></span>
                        </button>
                    </td>
                </tr>`).join('');
        }

        // 渲染分页
        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
            const pagination = document.getElementById('pagination');
            let html = `<nav><ul class="pagination">`;
            html += `<li class="page-item ${currentPage===1?'disabled':''}"><a class="page-link" href="#" onclick="changePage(1)">首页</a></li>`;
            html += `<li class="page-item ${currentPage===1?'disabled':''}"><a class="page-link" href="#" onclick="changePage(${currentPage -1})">上一页</a></li>`;
            let startPage = Math.max(1, currentPage-2);
            let endPage = Math.min(totalPages, currentPage+2);
            if(endPage - startPage < 4) {
                endPage = currentPage < 3 ? Math.min(totalPages, 5) : Math.min(totalPages, startPage+4);
                startPage = Math.max(1, endPage-4);
            }
            for(let i=startPage; i<=endPage; i++) {
                html += `<li class="page-item ${i===currentPage?'active':''}"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
            }
            html += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><a class="page-link" href="#" onclick="changePage(${currentPage+1})">下一页</a></li>`;
            html += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><a class="page-link" href="#" onclick="changePage(${totalPages})">尾页</a></li>`;
            html += `</ul></nav>`;
            pagination.innerHTML = html;
        }

        function changePage(newPage) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
            if(newPage<1 || newPage>totalPages) return;
            currentPage = newPage;
            renderTable();
            renderPagination();
            document.querySelector('.command-container').scrollIntoView({behavior:'smooth'});
        }

        function handleError(error) {
            showMessage(`数据加载失败: ${error.message}`, 'danger');
            logDebugInfo(`错误详情: ${error.stack}`);
        }
        function showMessage(message, type='info') {
            const loadingDiv = document.getElementById('loading');
            loadingDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            setTimeout(() => loadingDiv.innerHTML = '', 5000);
        }
        function renderCategory(category) {
            // const colors = { system:'primary', command:'secondary', network:'success', security:'danger', delay:'warning', original:'info', normal:'dark', default:'Light' };
            const colors = {scp:'success', log:'secondary', mysql:'secondary', cmd:'success', shell:'success', 物联网:'secondary', python:'secondary', git:'success', default:'light'};
            const color = colors[category.toLowerCase()] || colors.default;
            return `<span class="badge bg-${color}">${escapeHtml(category)}</span>`;
        }
        function renderComments(comments) {
            return comments ? escapeHtml(comments).replace(/\n/g, '<br>') : '<span class="text-muted">无注释</span>';
        }
        function escapeHtml(unsafe) {
            return (unsafe ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        }

        // 复制功能（支持 Clipboard API 及兼容回退）
        function copyText(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    return Promise.resolve();
                } catch (err) {
                    document.body.removeChild(textarea);
                    return Promise.reject(err);
                }
            }
        }

        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.copy-btn');
            if (!btn) return;
            const command = btn.dataset.command;
            try {
                btn.classList.add('disabled');
                await copyText(command);
                showMessage('命令已复制到剪贴板','success');
                logDebugInfo(`复制成功: ${command}`);
            } catch (err) {
                showMessage('复制失败，请手动复制','danger');
                logDebugInfo(`复制错误: ${err.message}`);
            } finally {
                setTimeout(() => btn.classList.remove('disabled'), 1000);
            }
        });

        // 触摸优化
        document.addEventListener('touchstart', (e) => { if(e.target.closest('.copy-btn')) e.preventDefault(); }, { passive: false });
    </script>
</body>
</html>